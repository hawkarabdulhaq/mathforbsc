<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ course_name }} • Registration</title>
  <style>
    :root{
      --black:#0b0b0b; --muted:#6d6d6d; --line:#e8e8e8; --bg:#fff; --accent:#111;
      --ok:#0a5a2a; --warn:#8a1f1f; --pill:#111; --radius:12px; --gap:12px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:#111;}
    header{background:linear-gradient(135deg,#000,#151515); color:#fff; padding:28px 16px;}
    .wrap{max-width:1120px; margin:0 auto; padding:0 16px;}
    .brand-row{display:flex; align-items:center; gap:16px;}
    .brand-row img{height:48px; width:auto; border-radius:8px; background:#fff;}
    .brand-row h1{margin:0; font-size:1.6rem;}
    .powered{opacity:.85; font-size:.9rem; margin-top:4px;}

    main{max-width:1120px; margin:24px auto 64px; padding:0 16px;}
    .layout{display:grid; grid-template-columns: 1.6fr .9fr; gap:20px;}
    @media (max-width:980px){ .layout{grid-template-columns:1fr} }

    .card{background:#fff; border:1px solid var(--line); border-radius:var(--radius); box-shadow:0 4px 18px rgba(0,0,0,.06); padding:20px;}
    .grid{display:grid; gap:var(--gap);}
    .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){ .cols-2,.cols-3{grid-template-columns:1fr} }

    label{font-weight:700; display:block; margin-bottom:6px;}
    input[type="text"],input[type="email"],input[type="tel"],input[type="number"],textarea,select{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff;
    }
    textarea{min-height:96px; resize:vertical;}
    .muted{color:var(--muted); font-size:.9rem;}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    button{appearance:none; border:1px solid var(--accent); background:var(--accent); color:#fff; padding:10px 16px; border-radius:10px; font-weight:800; cursor:pointer;}
    button.secondary{background:#fff; color:var(--accent);}
    a{color:#fff;} a:hover{text-decoration:underline;}
    .alert{padding:12px 14px; border-radius:10px; margin:8px 0 16px; border:1px solid}
    .alert.success{background:#eaf8ef; color:var(--ok); border-color:#c5e7cf;}
    .alert.error{background:#ffecec; color:var(--warn); border-color:#f5c0c0;}
    .topline{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;}
    .section{margin-top:4px; font-weight:900;}
    hr{border:0; height:1px; background:var(--line); margin:8px 0 16px;}
    .radio-row{display:flex; gap:16px; flex-wrap:wrap;}
    .radio-row label{font-weight:600; display:inline-flex; align-items:center; gap:6px; margin:0;}
    .hide{display:none;}
    footer{margin-top:28px; color:var(--muted); font-size:.9rem;}

    /* Summary card */
    .summary{position:sticky; top:16px; align-self:start}
    .sum-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;}
    .sum-title{font-weight:800; font-size:1.05rem;}
    .promo-pill{display:inline-flex; align-items:center; gap:8px; border:1px solid var(--pill); border-radius:999px; padding:6px 10px; font-weight:800;}
    .sum-row{display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px dashed var(--line);}
    .sum-row:last-child{border-bottom:none}
    .sum-row .label{color:#444}
    .sum-row .value{font-weight:700}
    .total{font-size:1.25rem;}
    .strike{opacity:.6; text-decoration:line-through;}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .sum-note{margin-top:8px; font-size:.9rem; color:var(--muted);}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand-row">
        <img src="{{ brand_logo_url }}" alt="{{ brand_name }} logo" />
        <div>
          <h1>{{ brand_name }} — Registration</h1>
          <div class="powered">Powered by: <strong>{{ powered_by }}</strong></div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="layout">
      <!-- LEFT: form -->
      <div class="card">
        <div class="topline">
          <span class="muted">Secure form • Used for course onboarding and billing.</span>
          {% if signed_in %}<a href="{{ url_for('logout') }}">Sign out</a>{% endif %}
        </div>

        {% with msgs = get_flashed_messages(with_categories=true) %}
          {% if msgs %}
            {% for category, msg in msgs %}
              <div class="alert {{ category }}">{{ msg|safe }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {% if not signed_in %}
          <form method="post" action="{{ url_for('signin') }}" class="grid cols-2" autocomplete="on" novalidate>
            <div>
              <label for="user_email">Email (optional)</label>
              <input id="user_email" name="user_email" type="email" placeholder="you@example.com" autocomplete="email" value="{{ (form_data.user_email if form_data else '') or '' }}" />
            </div>
            <div>
              <label for="access_code">Course Access Code</label>
              <input id="access_code" name="access_code" type="text" placeholder="Enter code" required />
            </div>
            <div class="actions">
              <button type="submit">Sign in</button>
            </div>
          </form>

        {% else %}
          {% if submitted %}
            <div class="alert success">✅ Thank you! Your registration has been received.</div>
            <p class="muted">You can close this tab, or submit another registration below.</p>
          {% endif %}

          {% if errors and errors|length %}
            <div class="alert error" role="alert">
              <strong>Please fix the following:</strong>
              <ul>
                {% for err in errors %}<li>{{ err }}</li>{% endfor %}
              </ul>
            </div>
          {% endif %}

          <form method="post" action="{{ url_for('register') }}" class="grid" novalidate>
            <!-- Course -->
            <div class="section">Course Selection</div><hr/>
            <div class="grid cols-2">
              <div>
                <label for="course_session_code">Choose your course</label>
                <select id="course_session_code" name="course_session_code" required>
                  <option value="">-- Select --</option>
                  {% for c in courses %}
                    <option value="{{ c.code }}" {% if form_data and form_data.course_session_code == c.code %}selected{% endif %}>{{ c.title }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="promo_code">Promo code (optional)</label>
                <input id="promo_code" name="promo_code" type="text" placeholder="Enter promo code" value="{{ (form_data.promo_code if form_data else '') or '' }}">
                <small class="muted">We’ll validate and apply the correct price.</small>
              </div>
            </div>

            <!-- Basic info -->
            <div class="section">Basic Information</div><hr/>
            <div class="grid cols-3">
              <div>
                <label for="first_name">First Name *</label>
                <input id="first_name" name="first_name" type="text" required autocomplete="given-name" value="{{ (form_data.first_name if form_data else '') or '' }}">
              </div>
              <div>
                <label for="middle_name">Middle Name</label>
                <input id="middle_name" name="middle_name" type="text" autocomplete="additional-name" value="{{ (form_data.middle_name if form_data else '') or '' }}">
              </div>
              <div>
                <label for="last_name">Last Name *</label>
                <input id="last_name" name="last_name" type="text" required autocomplete="family-name" value="{{ (form_data.last_name if form_data else '') or '' }}">
              </div>
            </div>

            <div class="grid cols-3">
              <div>
                <label for="age">Age</label>
                <input id="age" name="age" type="number" min="10" max="120" inputmode="numeric" value="{{ (form_data.age if form_data else '') or '' }}">
              </div>

              <!-- GENDER: DB-safe values -->
              <div>
                <label>Gender</label>
                <div class="radio-row" id="genderRow">
                  {% set gval = (form_data.gender if form_data and form_data.gender is not none else '') %}
                  <label><input type="radio" name="gender" value="female" {% if gval=='female' %}checked{% endif %}> Female</label>
                  <label><input type="radio" name="gender" value="male" {% if gval=='male' %}checked{% endif %}> Male</label>
                  <label><input type="radio" name="gender" value="other" {% if gval=='other' %}checked{% endif %}> Other</label>
                  <label><input type="radio" name="gender" value="prefer_not_to_say" {% if gval=='prefer_not_to_say' %}checked{% endif %}> Prefer not to say</label>
                </div>
                <div id="genderOtherWrap" class="{% if gval!='other' %}hide{% endif %}" style="margin-top:8px;">
                  <label for="gender_other_note">Please specify (optional)</label>
                  <input id="gender_other_note" name="gender_other_note" type="text" value="{{ (form_data.gender_other_note if form_data else '') or '' }}">
                </div>
              </div>

              <div>
                <label for="phone">Phone</label>
                <input id="phone" name="phone" type="tel" autocomplete="tel" value="{{ (form_data.phone if form_data else '') or '' }}">
              </div>
            </div>

            <div class="grid cols-2">
              <div>
                <label for="reg_email">Email</label>
                <input id="reg_email" name="user_email" type="email" autocomplete="email" value="{{ (form_data.user_email if form_data else (user_email or '')) or '' }}">
              </div>
              <div>
                <label for="job_title">Your Job / Role</label>
                <select id="job_title" name="job_title" required>
                  {% for r in job_roles %}
                    <option value="{{ r }}" {% if form_data and form_data.job_title==r %}selected{% endif %}>{{ r }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="grid cols-2">
              <div>
                <label for="company">Company / Organization</label>
                <input id="company" name="company" type="text" autocomplete="organization" value="{{ (form_data.company if form_data else '') or '' }}">
              </div>
              <div></div>
            </div>

            <!-- Address -->
            <div class="section">Address</div><hr/>
            <div class="grid cols-2">
              <div>
                <label for="address_line1">Address Line 1</label>
                <input id="address_line1" name="address_line1" type="text" autocomplete="address-line1" value="{{ (form_data.address_line1 if form_data else '') or '' }}">
              </div>
              <div>
                <label for="address_line2">Address Line 2</label>
                <input id="address_line2" name="address_line2" type="text" autocomplete="address-line2" value="{{ (form_data.address_line2 if form_data else '') or '' }}">
              </div>
            </div>
            <div class="grid cols-3">
              <div>
                <label for="city">City</label>
                <input id="city" name="city" type="text" autocomplete="address-level2" value="{{ (form_data.city if form_data else '') or '' }}">
              </div>
              <div>
                <label for="state">State / Province</label>
                <input id="state" name="state" type="text" autocomplete="address-level1" value="{{ (form_data.state if form_data else '') or '' }}">
              </div>
              <div>
                <label for="postal_code">Postal Code</label>
                <input id="postal_code" name="postal_code" type="text" autocomplete="postal-code" value="{{ (form_data.postal_code if form_data else '') or '' }}">
              </div>
            </div>
            <div>
              <label for="country">Country</label>
              <input id="country" name="country" type="text" autocomplete="country-name" value="{{ (form_data.country if form_data else '') or '' }}">
            </div>

            <!-- AI background -->
            <div class="section">AI Interest & Background</div><hr/>
            <div>
              <label for="ai_current_involvement">Describe your current involvement in AI (max 500 chars)</label>
              <textarea id="ai_current_involvement" name="ai_current_involvement" maxlength="500">{{ (form_data.ai_current_involvement if form_data else '') or '' }}</textarea>
            </div>
            <div>
              <label for="ai_goals_wish_to_achieve">What do you wish to achieve with AI? (max 500 chars)</label>
              <textarea id="ai_goals_wish_to_achieve" name="ai_goals_wish_to_achieve" maxlength="500">{{ (form_data.ai_goals_wish_to_achieve if form_data else '') or '' }}</textarea>
            </div>
            <div>
              <label for="ai_datasets_available">What datasets do you have? (format, size, sensitivity) (max 500 chars)</label>
              <textarea id="ai_datasets_available" name="ai_datasets_available" maxlength="500">{{ (form_data.ai_datasets_available if form_data else '') or '' }}</textarea>
            </div>

            <!-- Referral -->
            <div class="section">How did you find us & why choose us?</div><hr/>
            <div class="grid cols-2">
              <div>
                <label for="referral_source">How did you find us?</label>
                <select id="referral_source" name="referral_source">
                  <option value=""></option>
                  {% for r in referrals %}
                    <option value="{{ r }}" {% if form_data and form_data.referral_source==r %}selected{% endif %}>{{ r }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="reason_choose_us">Why did you choose us? (max 500 chars)</label>
                <textarea id="reason_choose_us" name="reason_choose_us" maxlength="500">{{ (form_data.reason_choose_us if form_data else '') or '' }}</textarea>
              </div>
            </div>

            <!-- Billing -->
            <div class="section">Invoice / Billing</div><hr/>
            <label>
              <input type="checkbox" id="billing_same" name="billing_same_as_personal" {% if not form_data or form_data.get('billing_same_as_personal', True) %}checked{% endif %}>
              Use same as personal details (recommended)
            </label>

            {% set show_billing = (form_data and not form_data.get('billing_same_as_personal', True)) %}
            <div id="billingFields" class="{% if not show_billing %}hide{% endif %}">
              <div class="grid cols-2">
                <div>
                  <label for="invoice_name">Billing Contact Name</label>
                  <input id="invoice_name" name="invoice_name" type="text" value="{{ (form_data.invoice_name if form_data else '') or '' }}">
                </div>
                <div>
                  <label for="invoice_company">Company</label>
                  <input id="invoice_company" name="invoice_company" type="text" value="{{ (form_data.invoice_company if form_data else '') or '' }}">
                </div>
              </div>
              <div class="grid cols-2">
                <div>
                  <label for="invoice_email">Billing Email</label>
                  <input id="invoice_email" name="invoice_email" type="email" value="{{ (form_data.invoice_email if form_data else '') or '' }}">
                </div>
                <div>
                  <label for="invoice_phone">Billing Phone</label>
                  <input id="invoice_phone" name="invoice_phone" type="tel" value="{{ (form_data.invoice_phone if form_data else '') or '' }}">
                </div>
              </div>
              <div class="grid cols-2">
                <div>
                  <label for="invoice_vat_id">VAT / Tax ID</label>
                  <input id="invoice_vat_id" name="invoice_vat_id" type="text" value="{{ (form_data.invoice_vat_id if form_data else '') or '' }}">
                </div>
                <div></div>
              </div>
              <div class="grid cols-2">
                <div>
                  <label for="invoice_addr_line1">Billing Address Line 1</label>
                  <input id="invoice_addr_line1" name="invoice_addr_line1" type="text" value="{{ (form_data.invoice_addr_line1 if form_data else '') or '' }}">
                </div>
                <div>
                  <label for="invoice_addr_line2">Billing Address Line 2</label>
                  <input id="invoice_addr_line2" name="invoice_addr_line2" type="text" value="{{ (form_data.invoice_addr_line2 if form_data else '') or '' }}">
                </div>
              </div>
              <div class="grid cols-3">
                <div>
                  <label for="invoice_city">City</label>
                  <input id="invoice_city" name="invoice_city" type="text" value="{{ (form_data.invoice_city if form_data else '') or '' }}">
                </div>
                <div>
                  <label for="invoice_state">State / Province</label>
                  <input id="invoice_state" name="invoice_state" type="text" value="{{ (form_data.invoice_state if form_data else '') or '' }}">
                </div>
                <div>
                  <label for="invoice_postal_code">Postal Code</label>
                  <input id="invoice_postal_code" name="invoice_postal_code" type="text" value="{{ (form_data.invoice_postal_code if form_data else '') or '' }}">
                </div>
              </div>
              <div>
                <label for="invoice_country">Country</label>
                <input id="invoice_country" name="invoice_country" type="text" value="{{ (form_data.invoice_country if form_data else '') or '' }}">
              </div>
            </div>

            <!-- Consents & notes -->
            <div class="section">Consents & Notes</div><hr/>
            <div class="grid">
              <label><input type="checkbox" name="consent_contact_ok" {% if not form_data or form_data.get('consent_contact_ok', True) %}checked{% endif %}> I agree to be contacted for course operations.</label>
              <label><input type="checkbox" name="consent_marketing_ok" {% if form_data and form_data.get('consent_marketing_ok') %}checked{% endif %}> I agree to receive updates and offers.</label>
              <label><input type="checkbox" name="data_processing_ok" required {% if not form_data or form_data.get('data_processing_ok', True) %}checked{% endif %}> I consent to the processing of my data for registration and billing.</label>
            </div>
            <div>
              <label for="notes">Any additional notes? (max 500 chars)</label>
              <textarea id="notes" name="notes" maxlength="500">{{ (form_data.notes if form_data else '') or '' }}</textarea>
            </div>

            <div class="actions">
              <button type="submit">Submit registration</button>
              <button type="reset" class="secondary">Reset</button>
            </div>
            <p class="muted">Fields marked * are required.</p>
          </form>
        {% endif %}
      </div>

      <!-- RIGHT: sticky summary -->
      <aside class="summary">
        <div class="card">
          <div class="sum-head">
            <div class="sum-title">Order Summary</div>
            <div id="promoPill" class="promo-pill" aria-live="polite">No promo</div>
          </div>
          <div class="sum-row">
            <div class="label">Base price</div>
            <div class="value" id="sumBase">€{{ base_price_eur }}</div>
          </div>
          <div class="sum-row hide" id="sumDiscountRow">
            <div class="label ok">Promo discount</div>
            <div class="value ok" id="sumDiscount">− €0</div>
          </div>
          <div class="sum-row total">
            <div class="label">Total</div>
            <div class="value" id="sumTotal">€{{ base_price_eur }}</div>
          </div>
          <div class="sum-note" id="sumNote">Enter a promo code to check if a discount applies.</div>
        </div>
      </aside>
    </div>

    <footer class="wrap">
      <div class="muted">© {{ brand_name }}. Powered by {{ powered_by }}.</div>
    </footer>
  </main>

  <script>
    // Sticky summary driven by server price preview
    const BASE = {{ base_price_eur }};
    const PREVIEW_URL = '{{ (base_path or "") }}/price-preview';

    const promoInput = document.getElementById('promo_code');
    const promoPill  = document.getElementById('promoPill');
    const sumBase    = document.getElementById('sumBase');
    const sumDiscountRow = document.getElementById('sumDiscountRow');
    const sumDiscount = document.getElementById('sumDiscount');
    const sumTotal   = document.getElementById('sumTotal');
    const sumNote    = document.getElementById('sumNote');

    function euro(n){ return "€" + Number(n).toString(); }

    async function refreshSummary(){
      const code = (promoInput?.value || '').trim();
      if (!code){
        // reset
        promoPill.textContent = "No promo";
        sumBase.textContent = euro(BASE);
        sumDiscountRow.classList.add('hide');
        sumTotal.textContent = euro(BASE);
        sumNote.textContent = "Enter a promo code to check if a discount applies.";
        return;
      }
      try{
        const res = await fetch(PREVIEW_URL, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body:new URLSearchParams({code})
        });
        const j = await res.json(); // { price_eur, promo_applied, is_free }
        const price = (j && typeof j.price_eur === 'number') ? j.price_eur : BASE;

        if (j && j.promo_applied){
          const discount = Math.max(0, BASE - price);
          sumBase.innerHTML = `<span class="strike">${euro(BASE)}</span>`;
          sumDiscountRow.classList.remove('hide');
          sumDiscount.textContent = "− " + euro(discount);
          sumTotal.textContent = euro(price);
          promoPill.textContent = j.is_free ? "Promo applied: FREE" : "Promo applied";
          sumNote.textContent = j.is_free
            ? "Valid promo detected. Your total will be €0 upon submission."
            : "Valid promo detected. The discounted total will be applied.";
        } else {
          promoPill.textContent = "Invalid promo";
          sumBase.textContent = euro(BASE);
          sumDiscountRow.classList.add('hide');
          sumTotal.textContent = euro(BASE);
          sumNote.textContent = "Promo not recognized. Base price applies.";
        }
      } catch(e){
        promoPill.textContent = "Promo check unavailable";
        sumBase.textContent = euro(BASE);
        sumDiscountRow.classList.add('hide');
        sumTotal.textContent = euro(BASE);
        sumNote.textContent = "We couldn’t verify the promo right now.";
      }
    }

    promoInput?.addEventListener('input', () => { refreshSummary(); });
    window.addEventListener('DOMContentLoaded', () => { refreshSummary(); });

    // Gender other toggle
    const genderRow = document.getElementById('genderRow');
    const genderOtherWrap = document.getElementById('genderOtherWrap');
    function onGenderChange(){
      const val = (document.querySelector('input[name="gender"]:checked') || {}).value;
      genderOtherWrap?.classList.toggle('hide', val !== 'other');
    }
    genderRow?.addEventListener('change', onGenderChange);
    window.addEventListener('DOMContentLoaded', onGenderChange);

    // Billing toggle
    const billingSame = document.getElementById('billing_same');
    const billingFields = document.getElementById('billingFields');
    function syncBilling(){ billingFields?.classList.toggle('hide', billingSame?.checked); }
    billingSame?.addEventListener('change', syncBilling);
    window.addEventListener('DOMContentLoaded', syncBilling);
  </script>
</body>
</html>
